version: "3.9"

services:
  api:
    build:
      context: ./api
    container_name: type-peptide-api
    env_file:
      - ./api/.env
    environment:
      # Puerto interno donde escucha la API
      PORT: 8052
      NODE_ENV: production

      # Ruta REAL del FASTA dentro del contenedor
      FASTA_PATH: /app/sequences/BD_FINAL.fasta
      FORCE_FASTA_ONLY: "false"

      # Si usas BD, los dejas listos aquí (puedes ajustarlos luego)
      DB_CONNECTION: ${DB_CONNECTION:-mysql}
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_DATABASE:-prospeccionydise}
      DB_USERNAME: ${DB_USERNAME:-prospeccionydise}
      DB_PASSWORD: ${DB_PASSWORD:-biomole1520}
      TABLE_NAME: ${TABLE_NAME:-}
      HEADER_COLUMN: ${HEADER_COLUMN:-}
      SEQUENCE_COLUMN: ${SEQUENCE_COLUMN:-}

    # Sólo se expone dentro de la red de Docker (no publica en el host)
    expose:
      - "8052"

    volumes:
      - ./api/sequences:/app/sequences:ro

    networks:
      - inverpep_default

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://localhost:8052/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  frontend:
    image: nginx:alpine
    container_name: type-peptide-frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

    # No publicamos puerto en el host, sólo lo "expose" para nginx-proxy
    expose:
      - "80"

    # Variables para nginx-proxy + letsencrypt
    environment:
      VIRTUAL_HOST: type-peptide.medellin.unal.edu.co
      LETSENCRYPT_HOST: type-peptide.medellin.unal.edu.co
      LETSENCRYPT_EMAIL: peptools_med@unal.edu.co
      VIRTUAL_PORT: 80

    networks:
      - inverpep_default

    restart: unless-stopped

networks:
  inverpep_default:
    external: true
